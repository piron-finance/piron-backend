"""
User entity - represents a wallet address
"""
type User @entity {
  id: ID! # wallet address (lowercase)
  walletAddress: Bytes!
  positions: [Position!]! @derivedFrom(field: "user")
  transactions: [Transaction!]! @derivedFrom(field: "user")
  withdrawalRequests: [WithdrawalRequest!]! @derivedFrom(field: "user")
  totalDeposited: BigDecimal!
  totalWithdrawn: BigDecimal!
  totalValueLocked: BigDecimal!
  poolCount: Int!
  firstInteractionAt: BigInt!
  lastInteractionAt: BigInt!
}

"""
Pool entity - both SINGLE_ASSET and STABLE_YIELD types
"""
type Pool @entity {
  id: ID! # pool address (lowercase)
  poolAddress: Bytes!
  poolType: PoolType!
  name: String!
  symbol: String
  asset: Bytes!
  assetSymbol: String!
  assetDecimals: Int!
  
  # Manager/Escrow
  managerAddress: Bytes!
  escrowAddress: Bytes!
  spvAddress: Bytes
  
  # Status
  status: PoolStatus!
  isActive: Boolean!
  isPaused: Boolean!
  
  # Financial data
  totalValueLocked: BigDecimal!
  totalShares: BigDecimal!
  targetRaise: BigDecimal
  minInvestment: BigDecimal
  
  # SINGLE_ASSET specific
  maturityDate: BigInt
  epochEndTime: BigInt
  discountRate: BigInt
  instrumentType: String
  
  # STABLE_YIELD specific
  navPerShare: BigDecimal
  lastNAVUpdate: BigInt
  expenseRatio: BigInt
  
  # Relationships
  positions: [Position!]! @derivedFrom(field: "pool")
  transactions: [Transaction!]! @derivedFrom(field: "pool")
  instruments: [Instrument!]! @derivedFrom(field: "pool")
  withdrawalRequests: [WithdrawalRequest!]! @derivedFrom(field: "pool")
  couponPayments: [CouponPayment!]! @derivedFrom(field: "pool")
  navSnapshots: [NAVSnapshot!]! @derivedFrom(field: "pool")
  emergencyEvents: [EmergencyEvent!]! @derivedFrom(field: "pool")
  
  # Analytics
  uniqueInvestors: Int!
  totalDeposits: BigDecimal!
  totalWithdrawals: BigDecimal!
  totalCouponsDistributed: BigDecimal!
  totalDiscountEarned: BigDecimal!
  
  # Timestamps
  createdAt: BigInt!
  createdAtBlock: BigInt!
  updatedAt: BigInt!
}

enum PoolType {
  SINGLE_ASSET
  STABLE_YIELD
}

enum PoolStatus {
  PENDING_DEPLOYMENT
  FUNDING
  FUNDED
  ACTIVE
  MATURED
  CLOSED
  EMERGENCY
  CANCELLED
}

"""
Position - user's position in a specific pool
"""
type Position @entity {
  id: ID! # userId-poolId
  user: User!
  pool: Pool!
  
  totalDeposited: BigDecimal!
  totalWithdrawn: BigDecimal!
  totalShares: BigDecimal!
  currentValue: BigDecimal!
  
  unrealizedReturn: BigDecimal!
  realizedReturn: BigDecimal!
  
  # SINGLE_ASSET specific
  totalCouponsClaimed: BigDecimal!
  totalDiscountAccrued: BigDecimal!
  
  # STABLE_YIELD specific
  firstDepositAt: BigInt
  lastDepositAt: BigInt
  
  isActive: Boolean!
  createdAt: BigInt!
  updatedAt: BigInt!
}

"""
Transaction - all deposit/withdrawal events
"""
type Transaction @entity {
  id: ID! # txHash-logIndex
  txHash: Bytes!
  logIndex: BigInt!
  
  user: User!
  pool: Pool!
  
  type: TransactionType!
  status: TransactionStatus!
  
  amount: BigDecimal!
  shares: BigDecimal!
  
  timestamp: BigInt!
  blockNumber: BigInt!
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  COUPON_CLAIM
  MATURITY_CLAIM
  REFUND
  EMERGENCY_WITHDRAWAL
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
}

"""
Instrument - Stable Yield pool holdings (T-bills, bonds, etc)
"""
type Instrument @entity {
  id: ID! # poolAddress-instrumentId
  pool: Pool!
  instrumentId: BigInt!
  instrumentType: InstrumentType!
  
  purchasePrice: BigDecimal!
  faceValue: BigDecimal!
  purchaseDate: BigInt!
  maturityDate: BigInt!
  
  annualCouponRate: BigInt!
  couponFrequency: Int!
  nextCouponDueDate: BigInt
  couponsPaid: Int!
  
  isActive: Boolean!
  realizedYield: BigDecimal
  
  couponPayments: [CouponPayment!]! @derivedFrom(field: "instrument")
  
  createdAt: BigInt!
  maturedAt: BigInt
}

enum InstrumentType {
  TBILL
  BOND
  NOTE
  OTHER
}

"""
CouponPayment - interest payments from instruments
"""
type CouponPayment @entity {
  id: ID! # poolAddress-instrumentId-couponNumber
  pool: Pool!
  instrument: Instrument
  
  amount: BigDecimal!
  couponNumber: Int!
  
  timestamp: BigInt!
  blockNumber: BigInt!
  txHash: Bytes!
}

"""
WithdrawalRequest - queued withdrawals for Stable Yield pools
"""
type WithdrawalRequest @entity {
  id: ID! # poolAddress-requestId
  pool: Pool!
  user: User!
  requestId: BigInt!
  
  shares: BigDecimal!
  estimatedValue: BigDecimal!
  actualValue: BigDecimal
  
  penaltyDeducted: BigDecimal
  
  requestTime: BigInt!
  processed: Boolean!
  processedTime: BigInt
  
  txHash: Bytes!
}

"""
NAVSnapshot - historical NAV data for Stable Yield pools
"""
type NAVSnapshot @entity {
  id: ID! # poolAddress-timestamp
  pool: Pool!
  
  totalNAV: BigDecimal!
  navPerShare: BigDecimal!
  totalShares: BigDecimal!
  
  reason: String!
  timestamp: BigInt!
  blockNumber: BigInt!
}

"""
EmergencyEvent - emergency states, pauses, cancellations
"""
type EmergencyEvent @entity {
  id: ID! # poolAddress-timestamp-type
  pool: Pool!
  
  eventType: EmergencyEventType!
  trigger: String
  caller: Bytes
  
  totalAmount: BigDecimal
  totalShares: BigDecimal
  
  timestamp: BigInt!
  blockNumber: BigInt!
  txHash: Bytes!
}

enum EmergencyEventType {
  PAUSE
  UNPAUSE
  EMERGENCY_STATE
  CANCELLATION
  EMERGENCY_EXIT
}

"""
PoolAnalytics - aggregated daily analytics (optional - can be derived)
"""
type PoolDailySnapshot @entity {
  id: ID! # poolAddress-dayId
  pool: Pool!
  dayId: Int! # timestamp / 86400
  
  totalValueLocked: BigDecimal!
  totalShares: BigDecimal!
  navPerShare: BigDecimal
  
  dailyDeposits: BigDecimal!
  dailyWithdrawals: BigDecimal!
  dailyVolume: BigDecimal!
  
  uniqueDepositors: Int!
  uniqueWithdrawers: Int!
  cumulativeInvestors: Int!
  
  timestamp: BigInt!
}

"""
Global protocol stats
"""
type ProtocolMetrics @entity {
  id: ID! # "protocol"
  
  totalValueLocked: BigDecimal!
  totalPools: Int!
  totalUsers: Int!
  totalTransactions: Int!
  
  totalSingleAssetPools: Int!
  totalStableYieldPools: Int!
  
  totalDeposits: BigDecimal!
  totalWithdrawals: BigDecimal!
  
  updatedAt: BigInt!
}

