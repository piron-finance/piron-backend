specVersion: 1.0.0
indexerHints:
  prune: auto
schema:
  file: ./schema.graphql
dataSources:
  # ============================================
  # POOL FACTORY (Single-Asset)
  # ============================================
  - kind: ethereum
    name: PoolFactory
    network: base-sepolia
    source:
      address: "0x4A7E6245CA1AaE0E0f159A8aF23b336542a30aF0"
      abi: PoolFactory
      startBlock: 33922889
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Pool
        - ProtocolMetrics
      abis:
        - name: PoolFactory
          file: ./abis/PoolFactory.json
        - name: LiquidityPool
          file: ./abis/LiquidityPool.json
        - name: IERC20
          file: ./abis/IERC20.json
      eventHandlers:
        - event: PoolCreated(indexed address,indexed address,indexed address,string,uint256,uint256)
          handler: handlePoolCreated
      file: ./src/mappings/pool-factory.ts

  # ============================================
  # MANAGED POOL FACTORY (Stable Yield)
  # ============================================
  - kind: ethereum
    name: ManagedPoolFactory
    network: base-sepolia
    source:
      address: "0x958b320E4cce5B6930b5695Bb9B817Ec01209D4a"
      abi: ManagedPoolFactory
      startBlock: 33922889
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Pool
        - ProtocolMetrics
      abis:
        - name: ManagedPoolFactory
          file: ./abis/ManagedPoolFactory.json
        - name: StableYieldPool
          file: ./abis/StableYieldPool.json
        - name: IERC20
          file: ./abis/IERC20.json
      eventHandlers:
        - event: StableYieldPoolCreated(indexed address,indexed address,indexed address,string,address)
          handler: handleStableYieldPoolCreated
      file: ./src/mappings/managed-pool-factory.ts

  # ============================================
  # MANAGER (Single-Asset)
  # ============================================
  - kind: ethereum
    name: Manager
    network: base-sepolia
    source:
      address: "0x056dAC51BF925e88d5d9eA3394D70b55A1691Da2"
      abi: Manager
      startBlock: 33922889
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Pool
        - Transaction
        - CouponPayment
        - EmergencyEvent
      abis:
        - name: Manager
          file: ./abis/Manager.json
      eventHandlers:
        - event: Deposit(address,indexed address,indexed address,uint256,uint256)
          handler: handleManagerDeposit
        - event: CouponPaymentReceived(indexed address,uint256)
          handler: handleCouponPaymentReceived
        - event: CouponDistributed(indexed address,uint256,uint256)
          handler: handleCouponDistributed
        - event: CouponClaimed(indexed address,indexed address,uint256)
          handler: handleCouponClaimed
        - event: InvestmentConfirmed(uint256,string)
          handler: handleInvestmentConfirmed
        - event: MaturityProcessed(uint256)
          handler: handleMaturityProcessed
        - event: PoolFilled(indexed address,uint256,uint256)
          handler: handlePoolFilled
        - event: PoolCancelled(indexed address,indexed address,uint256)
          handler: handlePoolCancelled
        - event: EmergencyStateChanged(indexed address,string,uint256,uint256,uint256)
          handler: handleEmergencyStateChanged
        - event: PoolPaused(indexed address,uint256)
          handler: handlePoolPaused
        - event: PoolUnpaused(indexed address,uint256)
          handler: handlePoolUnpaused
        - event: SPVFundsWithdrawn(indexed address,uint256,bytes32)
          handler: handleSPVFundsWithdrawn
        - event: SPVFundsReturned(indexed address,uint256)
          handler: handleSPVFundsReturned
      file: ./src/mappings/manager.ts

  # ============================================
  # STABLE YIELD MANAGER
  # ============================================
  - kind: ethereum
    name: StableYieldManager
    network: base-sepolia
    source:
      address: "0xE756E61e69cd090Cfe7bF0648c6f488c47629a80"
      abi: StableYieldManager
      startBlock: 33922889
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Pool
        - Instrument
        - NAVSnapshot
        - WithdrawalRequest
        - CouponPayment
      abis:
        - name: StableYieldManager
          file: ./abis/StableYieldManager.json
      eventHandlers:
        - event: PoolRegistered(indexed address,indexed address,indexed address,string)
          handler: handlePoolRegistered
        - event: DepositValidated(indexed address,indexed address,uint256,uint256)
          handler: handleDepositValidated
        - event: WithdrawalValidated(indexed address,indexed address,uint256,uint256,bool)
          handler: handleWithdrawalValidated
        - event: WithdrawalQueued(indexed address,indexed address,indexed uint256,uint256,uint256)
          handler: handleWithdrawalQueued
        - event: WithdrawalProcessed(indexed address,indexed address,indexed uint256,uint256,uint256)
          handler: handleWithdrawalProcessed
        - event: InstrumentPurchased(indexed address,indexed uint256,uint8,uint256,uint256,uint256)
          handler: handleInstrumentPurchased
        - event: InstrumentMatured(indexed address,indexed uint256,uint256,uint256)
          handler: handleInstrumentMatured
        - event: CouponPaymentReceived(indexed address,indexed uint256,uint256,uint256)
          handler: handleStableYieldCouponPayment
        - event: NAVUpdated(indexed address,uint256,uint256,string,uint256)
          handler: handleNAVUpdated
        - event: ReservesRebalanced(indexed address,uint256,uint256)
          handler: handleReservesRebalanced
        - event: PoolDeactivated(indexed address,uint256)
          handler: handlePoolDeactivated
      file: ./src/mappings/stable-yield-manager.ts

# ============================================
# DYNAMIC DATA SOURCES (Pool Templates)
# ============================================
templates:
  # Single-Asset Pool Template
  - kind: ethereum/contract
    name: LiquidityPool
    network: base-sepolia
    source:
      abi: LiquidityPool
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Pool
        - User
        - Position
        - Transaction
      abis:
        - name: LiquidityPool
          file: ./abis/LiquidityPool.json
      eventHandlers:
        - event: Deposit(indexed address,indexed address,uint256,uint256)
          handler: handleDeposit
        - event: Withdraw(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleWithdraw
        - event: CouponClaimed(indexed address,uint256)
          handler: handleCouponClaimed
        - event: DiscountAccrued(indexed address,uint256)
          handler: handleDiscountAccrued
        - event: EmergencyWithdrawal(indexed address,uint256,uint256)
          handler: handleEmergencyWithdrawal
        - event: RefundClaimed(indexed address,uint256)
          handler: handleRefundClaimed
        - event: Paused(address)
          handler: handlePaused
        - event: Unpaused(address)
          handler: handleUnpaused
      file: ./src/mappings/liquidity-pool.ts

  # Stable Yield Pool Template
  - kind: ethereum/contract
    name: StableYieldPool
    network: base-sepolia
    source:
      abi: StableYieldPool
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Pool
        - User
        - Position
        - Transaction
      abis:
        - name: StableYieldPool
          file: ./abis/StableYieldPool.json
      eventHandlers:
        - event: Deposit(indexed address,indexed address,uint256,uint256)
          handler: handleDeposit
        - event: Withdraw(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleWithdraw
        - event: WithdrawalRequested(indexed address,uint256,uint256)
          handler: handleWithdrawalRequested
        - event: HoldingPeriodViolation(indexed address,uint256)
          handler: handleHoldingPeriodViolation
        - event: Paused(address)
          handler: handlePaused
        - event: Unpaused(address)
          handler: handleUnpaused
      file: ./src/mappings/stable-yield-pool.ts

